#
# @brief   User-defined functions for git env
# @version ver.1.8.6
# @date    Sun 13 Feb 2022 10:52:42 AM CET
# @company None, free software to use 2022
# @author  Vladimir Roncevic <elektron.ronca@gmail.com>
#

# Git helper
function __git_helper {
    read -r -d '' END_HELP_TXT <<- END_HELP_TXT
### List all big changes (no arguments)
    check_big_changes

### List all conflicts (no arguments)
    list_conflicts

### List all files with conflits (no arguments)
    list_conflit_files

### List before clean up (no arguments)
    clean_list

### Clean up repo and fetch all changes (no arguments)
    clean_fetch_all

### Setup github ssh key
    add_git_ssh

END_HELP_TXT
    echo "$END_HELP_TXT"
}

# setup github ssh key
function __add_git_ssh {
    eval "$(ssh-agent -s)"
    ssh-add ~/.ssh/id_ed25519
    return 0
}


# List all conflicts
function __list_conflicts {
    git ls-files -u | cut -f 2 | sort -u
    return 0
}

# List file names with conflicts
function __list_conflit_files {
    git diff --name-only --diff-filter=U
    return 0
}

# List before clean up
function __clean_list {
    git clean -nfd .
    return 0
}

# Fetch all and clean repo
function __clean_fetch_all {
    git fetch --all --prune
    return 0
}

# Check commits with big changes
function __check_big_changes {
    local BATCH_CHECK='%(objecttype) %(objectname) %(objectsize) %(rest)'
    git rev-list --objects --all | \
    git cat-file --batch-check=${BATCH_CHECK} | \
    sed -n 's/^blob //p' | \
    sort --numeric-sort --key=2 | \
    cut -c 1-12,41- | \
    $(command -v gnumfmt || echo numfmt) \
    --field=2 --to=iec-i --suffix=B --padding=7 --round=nearest
    return 0
}

